<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Attendance & Analytics System</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Import the Firebase SDK -->
    <script type="module">
        // Firebase App (Core)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        // Firestore Database
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, query, deleteDoc, updateDoc, where, Timestamp, getDocs, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        // Firebase Auth
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCThXRLU-cK77DZN2A4pP7fGej7G4U41ic",
            authDomain: "sih-2025-attendance.firebaseapp.com",
            projectId: "sih-2025-attendance",
            storageBucket: "sih-2025-attendance.appspot.com",
            messagingSenderId: "134749640583",
            appId: "1:134749640583:web:45ba659078acc62ec5a522",
            measurementId: "G-CBDLJ341KG"
        };
        // ---------------------------------------------------------

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Make services globally available
        window.db = db;
        window.auth = auth;
        window.firebase = { 
            collection, addDoc, onSnapshot, doc, setDoc, query, deleteDoc, updateDoc, where, Timestamp, getDocs, getDoc, writeBatch,
            GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
        };
    </script>

    <style>
        :root {
            --primary-color: #3B82F6;
            --primary-hover: #2563EB;
            --secondary-color: #6B7280;
            --background-color: #F9FAFB;
            --panel-color: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --success-color: #10B981;
            --error-color: #EF4444;
            --border-color: #E5E7EB;
            --font-family: 'Poppins', sans-serif;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        #role-selection, #faculty-login-container {
            display: flex;
            flex-direction: column; justify-content: center;
            align-items: center; min-height: 100vh; padding: 2rem;
            width: 100%;
        }
        .role-card {
            background-color: var(--panel-color);
            border-radius: 16px; padding: 2.5rem 4rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin: 1rem; text-align: center;
            border: 1px solid var(--border-color);
            z-index: 10;
        }
        .role-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .role-card svg {
            width: 48px;
            height: 48px; margin-bottom: 1rem; color: var(--primary-color);
        }
        .role-card h2 { color: var(--text-primary);
            margin: 0; font-weight: 600; }
        
        #app-container { display: none;
            width: 100%; padding: 2rem; }
        .header { position: relative; text-align: center; margin-bottom: 3rem;
            width: 100%; }
        .header h1 { color: var(--text-primary); font-weight: 700; margin: 0;
            font-size: 2rem; }
        .header p { color: var(--text-secondary); font-size: 1.1rem; margin-top: 0.5rem;
        }
        #back-btn { position: absolute; top: 0; left: 0;
        }
        #sign-out-btn {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--error-color);
        }
        #sign-out-btn:hover {
            background-color: #DC2626;
        }

        .main-container { display: grid; gap: 2rem; width: 100%;
        }
        .main-container { grid-template-columns: 1fr; max-width: 1200px; margin: 0 auto;
        }
        .main-container.faculty-view .student-portal, .main-container.faculty-view .admin-portal,
        .main-container.student-view .faculty-portal, .main-container.student-view .admin-portal,
        .main-container.admin-view .faculty-portal, .main-container.admin-view .student-portal { display: none;
        }
        
        .panel {
            background-color: var(--panel-color);
            border-radius: 16px; padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        .panel-header {
            display: flex;
            align-items: center; gap: 1rem;
        }
        .panel-header h2, .panel-header h3 { margin: 0;
            color: var(--text-primary); font-size: 1.5rem; font-weight: 600; }
        .panel-header .panel-icon { color: var(--primary-color);
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none; padding: 14px 24px; border-radius: 8px; cursor: pointer;
            font-size: 1rem; font-weight: 600; transition: all 0.2s ease;
            width: 100%; margin-bottom: 1rem;
        }
        .btn:hover { background-color: var(--primary-hover); transform: translateY(-2px);
        }
        .btn:disabled {
            background-color: #9CA3AF;
            cursor: not-allowed; transform: none;
        }
        .btn-small {
            background: var(--secondary-color);
            color: white; border: none; padding: 10px 15px;
            border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-small:hover { background: var(--text-secondary);
        }
        .btn-delete {
             background-color: var(--error-color);
        }
        .btn-delete:hover {
             background-color: #ca3a3a;
        }
        
        .status-box {
            background-color: #F9FAFB;
            border-left: 5px solid var(--secondary-color);
            padding: 1rem; margin-top: 1rem; border-radius: 6px; font-size: 0.9rem;
        }
        .status-box.success { border-color: var(--success-color); background-color: #F0FDF4;
        }
        .status-box.error { border-color: var(--error-color); background-color: #FEF2F2;
        }
        .status-box.info { border-color: var(--primary-color); background-color: #EFF6FF;
        }
        
        #present-list, #student-active-session-list { list-style-type: none;
            padding: 0; overflow-y: auto; }
        #present-list { max-height: 250px;
        }
        #present-list li, #student-active-session-list li {
            display: flex;
            justify-content: space-between; background-color: #EFF6FF;
            padding: 0.75rem; border-radius: 8px; margin-top: 0.5rem; font-weight: 500;
        }
        #student-active-session-list li { cursor: pointer; transition: background-color 0.2s;
        }
        #student-active-session-list li:hover { background-color: #DBEAFE;
        }

        .timestamp { color: var(--text-secondary); font-size: 0.8rem;
        }
        
        .session-code-display {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1rem;
        }
        .session-code-display p {
            margin: 0;
            font-size: 1rem;
            font-weight: 500;
            opacity: 0.8;
        }
        .session-code-display h3 {
            margin: 0.5rem 0 0 0;
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 0.25rem;
            color: white;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 450px; 
            margin: 1.5rem auto; 
            padding-top: 100%; 
            height: 0;
            display: none;
            background: #111;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid var(--border-color);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
        }
        .video-container:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        video, canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        h3 { margin: 1.5rem 0 1rem 0; text-align: center; font-weight: 600;
            color: var(--text-primary); }
        h4 { margin: 1.5rem 0 1rem 0; text-align: center;
            font-weight: 600; color: var(--text-primary); }

        .form-group { display: flex; flex-direction: column; gap: 0.5rem;
            margin-bottom: 1rem; }
        .form-group label {
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        input, select, textarea {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.9rem;
            width: 100%;
            background-color: var(--background-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input#classroom-code-input {
            text-transform: uppercase;
            text-align: center;
            font-size: 1.5rem;
            letter-spacing: 0.25rem;
            font-weight: bold;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        .roster-actions { position: relative;
        }
        .roster-menu-btn {
            background: none;
            border: none; font-size: 1.25rem; line-height: 1;
            cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 6px; color: var(--text-secondary);
        }
        .roster-menu-btn:hover { background-color: var(--border-color); color: var(--text-primary);
        }
        .roster-menu {
            display: none;
            position: absolute; right: 0; top: 110%;
            background-color: var(--panel-color); border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            z-index: 10; list-style: none; padding: 0.5rem 0; margin: 0;
            min-width: 160px;
            border: 1px solid var(--border-color);
        }
        .roster-menu.active { display: block;
        }
        .roster-menu li { padding: 0.6rem 1rem; cursor: pointer; font-size: 0.9rem;
        }
        .roster-menu li:hover { background-color: #F3F4F6;
        }
        .roster-menu li.delete { color: var(--error-color);
        }
        
        .faculty-nav { display: flex;
            border-bottom: 1px solid var(--border-color); margin-bottom: 2rem; flex-wrap: wrap;}
        .nav-tab {
            padding: 0.75rem 1.25rem;
            border: none; background: none;
            cursor: pointer; font-size: 1rem; font-weight: 500; color: var(--text-secondary);
            border-bottom: 3px solid transparent; margin-bottom: -1px;
        }
        .nav-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color);
        }
        .faculty-view-content, .student-view-content, .admin-view-content { display: none;
        }
        .faculty-view-content.active, .student-view-content.active, .admin-view-content.active { display: block;
        }

        .roster-header { display: flex; justify-content: space-between; align-items: center;
        }
        
        .add-student-form, .add-faculty-form {
            display: none;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
            background-color: var(--background-color);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .table-container {
            overflow-x: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .data-table th {
            background-color: var(--background-color);
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .data-table th:hover {
            background-color: #F3F4F6;
        }
        .data-table tbody tr:hover {
            background-color: var(--background-color);
        }
        .data-table .actions-cell {
            text-align: right;
        }
        .clickable-row {
            cursor: pointer;
        }
        
        .division-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            background-color: var(--background-color);
            padding: 1rem;
            border-radius: 8px;
        }
        .division-checkbox-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* Styles for Analytics View */
        #analytics-view.active {
            display: grid;
            gap: 1.5rem;
        }
        .analytics-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .chart-card {
            background-color: var(--panel-color);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
        .chart-card h4 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 600;
        }
        .donut-chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        .trend-chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .export-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* Student History View Styles */
        .history-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
            align-items: flex-start;
        }
        .filters-panel {
            background-color: var(--background-color);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        .filters-panel h4 {
            margin-top: 0;
            text-align: left;
        }
        .history-content h4 {
            text-align: left;
            margin-top: 0;
        }
        .status-present {
            color: var(--success-color);
            background-color: #F0FDF4;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .status-absent {
            color: var(--error-color);
            background-color: #FEF2F2;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        @media (max-width: 768px) {
            .history-container {
                grid-template-columns: 1fr;
            }
        }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p>Initializing...</p>
    </div>

    <div id="role-selection">
        <div class="header"><h1>Welcome to the System</h1><p>Please select your role to continue</p></div>
        <div class="role-card" id="select-faculty-btn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
            <h2>Faculty</h2>
        </div>
        <div class="role-card" id="google-login-btn">
             <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.242,44,30.038,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
            <h2>Admin Login</h2>
        </div>
        <div class="role-card" id="select-student-btn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
            <h2>Student</h2>
        </div>
        <div id="login-status" class="status-box" style="display: none; margin-top: 2rem; text-align: center;"></div>
    </div>

     <div id="faculty-login-container" style="display: none;">
        <div class="header"><h1>Faculty Login</h1></div>
        <div class="panel" style="width: 100%; max-width: 400px;">
            <div class="form-group">
                <label for="faculty-username-input">Username</label>
                <input type="text" id="faculty-username-input" placeholder="Enter your username">
            </div>
            <div class="form-group">
                <label for="faculty-password-input">Password</label>
                <input type="password" id="faculty-password-input" placeholder="Enter your password">
            </div>
            <button id="faculty-login-btn" class="btn">Login</button>
            <button id="faculty-login-back-btn" class="btn-small" style="width: 100%; margin:0;">Back to Role Selection</button>
            <div id="faculty-login-status" class="status-box" style="display: none; margin-top: 1rem;"></div>
        </div>
    </div>

    <div id="app-container">
        <header class="header">
            <button id="back-btn" class="btn-small">Switch Role</button>
            <h1>Automated Attendance System</h1>
            <p>A live demonstration of Face-based Verification</p>
            <button id="sign-out-btn" class="btn-small" style="display: none;">Sign Out</button>
        </header>

        <div class="main-container">
            <!-- Faculty Portal -->
            <div class="panel faculty-portal">
                <div class="panel-header">
                    <span class="panel-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="32" height="32"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg></span>
                    <h2>Faculty Portal</h2>
                </div>
                 <nav class="faculty-nav">
                    <button class="nav-tab active" data-view="conduct-session">Conduct Session</button>
                    <button class="nav-tab" data-view="live-attendance">Live Attendance</button>
                    <button class="nav-tab" data-view="attendance-history">Attendance History</button>
                    <button class="nav-tab" data-view="class-roster">Class Roster</button>
                    <button class="nav-tab" data-view="analytics">Analytics Dashboard</button>
                </nav>

                <div id="conduct-session-view" class="faculty-view-content active">
                    <h3>Conduct New Session</h3>
                    <div class="form-group">
                        <label for="lecture-name">Lecture/Lab Name</label>
                        <input type="text" id="lecture-name" placeholder="e.g., Intro to AI">
                    </div>
                    <div class="form-group">
                        <label for="session-department-select">Department</label>
                        <select id="session-department-select">
                            <option value="IT">IT</option>
                            <option value="CSE">CSE</option>
                            <option value="ECE">ECE</option>
                            <option value="Elect">Electrical</option>
                            <option value="Mech">Mechanical</option>
                            <option value="Automobiles">Automobiles</option>
                            <option value="Civil">Civil</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="session-semester-select">Semester</label>
                        <select id="session-semester-select">
                            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Division (Leave all unchecked for a combined session)</label>
                        <div id="session-division-checkboxes" class="division-checkbox-group">
                            <!-- Checkboxes will be dynamically inserted here -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="lecture-description">Description</label>
                        <textarea id="lecture-description" rows="3" placeholder="e.g., Chapter 1 basics..."></textarea>
                    </div>
                    <button class="btn" id="start-session-btn">Start Attendance Session</button>
                    <button class="btn" id="close-session-btn" disabled style="background-color: var(--error-color);">Close Session</button>
                    <div class="status-box" id="faculty-status">Session has not started.</div>
                    <div id="session-code-container" style="display: none;" class="session-code-display">
                        <p>Share this code with your students:</p>
                        <h3 id="session-code-text"></h3>
                    </div>
                </div>

                <div id="live-attendance-view" class="faculty-view-content">
                    <h3>Live Attendance</h3>
                    <ul id="present-list"></ul>
                    <div id="live-attendance-placeholder" class="status-box info" style="display: none;">No active session. Please start a new session to see live attendance.</div>
                </div>

                <div id="attendance-history-view" class="faculty-view-content">
                    <h3>Attendance History</h3>
                    <div class="form-group">
                        <label for="history-date-picker">Select a Date</label>
                        <input type="date" id="history-date-picker">
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Session Name</th>
                                    <th>Department</th>
                                    <th>Sem</th>
                                    <th>Div</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="past-sessions-table-body"></tbody>
                        </table>
                    </div>
                    <h3 id="present-list-header" style="margin-top: 2rem;">Selected Session Attendees</h3>
                    <div class="table-container">
                        <table class="data-table">
                             <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="history-present-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="class-roster-view" class="faculty-view-content">
                    <h3>Class Roster (View Only)</h3>
                     <div class="form-group">
                        <label for="faculty-roster-search-input">Search Roster</label>
                        <input type="text" id="faculty-roster-search-input" placeholder="Search by name, ID, or department...">
                    </div>
                    <div class="table-container">
                         <table class="data-table">
                            <thead>
                                <tr>
                                    <th data-column="name">Student Name</th>
                                    <th data-column="studentId">Student ID</th>
                                    <th data-column="department">Department</th>
                                    <th data-column="semester">Semester</th>
                                    <th data-column="division">Division</th>
                                </tr>
                            </thead>
                            <tbody id="faculty-roster-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="faculty-student-history-view" class="faculty-view-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <h3 id="faculty-student-history-header" style="margin: 0;">Student Attendance History</h3>
                        <button id="back-to-roster-btn" class="btn-small">Back to Roster</button>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Lecture Name</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="faculty-student-history-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="analytics-view" class="faculty-view-content">
                    <h3>Analytics Dashboard</h3>
                    <div class="analytics-filters">
                        <div class="form-group">
                            <label for="analytics-date-range">Date Range</label>
                            <select id="analytics-date-range">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month" selected>This Month</option>
                                <option value="semester">This Semester</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="analytics-department">Department</label>
                            <select id="analytics-department">
                                <option value="all">All Departments</option>
                                <option value="IT">IT</option>
                                <option value="CSE">CSE</option>
                                <option value="ECE">ECE</option>
                                <option value="Elect">Electrical</option>
                                <option value="Mech">Mechanical</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="analytics-semester">Semester</label>
                            <select id="analytics-semester">
                                <option value="all">All Semesters</option>
                                <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option>
                            </select>
                        </div>
                    </div>

                    <div class="analytics-grid">
                        <div class="chart-card">
                            <h4>Overall Attendance</h4>
                            <div class="donut-chart-container">
                                <canvas id="overall-attendance-chart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4>Department-wise Absence %</h4>
                            <div class="trend-chart-container">
                                <canvas id="department-absence-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-card" style="margin-top: 1.5rem;">
                        <h4>Daily Attendance Trends</h4>
                        <div class="trend-chart-container">
                            <canvas id="daily-trends-chart"></canvas>
                        </div>
                    </div>
                     <div class="chart-card" style="margin-top: 1.5rem;">
                        <h4>Student Performance</h4>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Student Name</th>
                                        <th>Attendance %</th>
                                    </tr>
                                </thead>
                                <tbody id="student-performance-table"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="export-buttons">
                        <button id="export-pdf-btn" class="btn-small">Export as PDF</button>
                        <button id="export-csv-btn" class="btn-small">Export as CSV</button>
                    </div>
                </div>

            </div>

            <!-- Admin Portal -->
            <div class="panel admin-portal">
                 <div class="panel-header">
                    <span class="panel-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="32" height="32"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.008h-.008v-.008z" /></svg></span>
                    <h2>Admin Portal</h2>
                </div>
                
                 <nav class="faculty-nav">
                    <button class="nav-tab active" data-view="manage-students">Manage Students</button>
                    <button class="nav-tab" data-view="manage-faculty">Manage Faculty</button>
                    <button class="nav-tab" data-view="manual-attendance">Take Attendance Manually</button>
                </nav>

                <div id="manage-students-view" class="admin-view-content active">
                    <div class="roster-header">
                        <h3>College Roster</h3>
                        <button id="admin-show-add-student-form-btn" class="btn-small" style="background: var(--primary-color);">Add New Student</button>
                    </div>
                    <div class="add-student-form">
                        <div class="form-group">
                            <label for="student-name-input">Student Name</label>
                            <input type="text" id="student-name-input" placeholder="e.g., Jane Doe">
                        </div>
                        <div class="form-group">
                            <label for="student-id-input">Unique Student ID</label>
                            <input type="text" id="student-id-input" placeholder="e.g., S2025001">
                        </div>
                        <div class="form-group">
                            <label for="department-select">Department</label>
                            <select id="department-select">
                                <option value="IT">IT</option>
                                <option value="CSE">CSE</option>
                                <option value="ECE">ECE</option>
                                <option value="Elect">Electrical</option>
                                <option value="Mech">Mechanical</option>
                                <option value="Automobiles">Automobiles</option>
                                <option value="Civil">Civil</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="student-semester-select">Semester</label>
                            <select id="student-semester-select">
                                <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="student-division-input">Division</label>
                            <input type="text" id="student-division-input" placeholder="e.g., A, B">
                        </div>
                        <button class="btn-small" id="add-student-btn" style="background: var(--primary-color);">Capture Face & Add Student</button>
                        <div class="video-container" id="enroll-video-container">
                            <video id="enroll-video" autoplay muted playsinline></video>
                        </div>
                        <button class="btn-small" id="capture-enroll-btn" style="display: none; background: var(--success-color); margin-top: 0.5rem;">Take Snapshot</button>
                    </div>

                    <div class="form-group" style="margin-top: 2rem;">
                        <label for="roster-search-input">Search Roster</label>
                        <input type="text" id="roster-search-input" placeholder="Search by name, ID, or department...">
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th data-column="name">Student Name</th>
                                    <th data-column="studentId">Student ID</th>
                                    <th data-column="department">Department</th>
                                    <th data-column="semester">Semester</th>
                                    <th data-column="division">Division</th>
                                    <th class="actions-cell">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="roster-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="manage-faculty-view" class="admin-view-content">
                    <h3>Manage Faculty</h3>
                    <div class="add-faculty-form" style="display: flex;">
                        <h4>Add New Faculty</h4>
                         <div class="form-group">
                            <label for="new-faculty-name">Faculty Name</label>
                            <input type="text" id="new-faculty-name" placeholder="e.g., Prof. Smith">
                        </div>
                        <div class="form-group">
                            <label for="new-faculty-username">Faculty Username</label>
                            <input type="text" id="new-faculty-username" placeholder="e.g., psmith">
                        </div>
                        <div class="form-group">
                            <label for="new-faculty-password">Password</label>
                            <input type="password" id="new-faculty-password">
                        </div>
                        <button class="btn-small" id="add-faculty-btn" style="background: var(--primary-color);">Add Faculty</button>
                        <div id="add-faculty-status" class="status-box" style="display: none;"></div>
                    </div>

                    <h4 style="margin-top: 2rem;">Existing Faculty</h4>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Faculty Name</th>
                                    <th>Username</th>
                                    <th class="actions-cell">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="faculty-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="manual-attendance-view" class="admin-view-content">
                    <h3>Manual Attendance</h3>
                    <div class="form-group">
                        <label for="manual-session-select">Select an Active Session</label>
                        <select id="manual-session-select">
                            <option value="">-- Loading sessions... --</option>
                        </select>
                    </div>

                    <div id="manual-attendance-student-list" style="display:none;">
                        <h4>Mark Students Present</h4>
                         <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Present</th>
                                        <th>Student Name</th>
                                        <th>Student ID</th>
                                    </tr>
                                </thead>
                                <tbody id="manual-attendance-table-body"></tbody>
                            </table>
                        </div>
                        <button id="save-manual-attendance-btn" class="btn" style="margin-top: 1.5rem;">Save Attendance</button>
                    </div>
                    <div id="manual-attendance-status" class="status-box" style="display: none;"></div>
                </div>
            </div>

            <!-- Student Portal -->
            <div class="panel student-portal">
                 <div class="panel-header">
                    <span class="panel-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="32" height="32"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg></span>
                    <h2>Student Portal</h2>
                </div>
                <button class="btn" id="identify-me-btn">Identify Me...</button>
                <div class="status-box" id="student-status">Click the button above to start verification.</div>
                
                <div class="video-container" id="attend-video-container">
                    <video id="attend-video" autoplay muted playsinline></video>
                </div>
                <div id="student-dashboard" style="display: none;">
                    <div class="panel-header" style="margin-bottom: 1.5rem;">
                        <h3 id="student-welcome-header">Welcome!</h3>
                    </div>
                    <nav class="faculty-nav">
                        <button class="nav-tab active" data-view="active-session">Mark Attendance</button>
                        <button class="nav-tab" data-view="attendance-list">My History</button>
                        <button class="nav-tab" data-view="my-analytics">My Analytics</button>
                    </nav>

                    <div id="active-session-view" class="student-view-content active">
                        <h3>Mark My Attendance</h3>
                        <p>Get the 5-character code from your faculty and enter it below to mark your attendance.</p>
                        <div class="form-group">
                            <label for="classroom-code-input">Classroom Code</label>
                            <input type="text" id="classroom-code-input" maxlength="5" placeholder="_ _ _ _ _">
                        </div>
                        <button class="btn" id="submit-code-btn">Submit Code</button>
                        <div class="status-box" id="student-active-session-status" style="display: none;"></div>
                    </div>

                    <div id="my-analytics-view" class="student-view-content">
                        <div class="history-container">
                            <div class="filters-panel">
                                <h4>Filters</h4>
                                 <div class="form-group">
                                    <label for="student-analytics-start-date">Start Date</label>
                                    <input type="date" id="student-analytics-start-date">
                                </div>
                                <div class="form-group">
                                    <label for="student-analytics-end-date">End Date</label>
                                    <input type="date" id="student-analytics-end-date">
                                </div>
                                <button class="btn-small" id="fetch-student-analytics-btn" style="width: 100%;">Update Chart</button>
                            </div>
                            <div class="history-content">
                                <h4>Daily Absence Count</h4>
                                <div id="student-analytics-loader" class="status-box info" style="display: none; text-align: center;">Loading...</div>
                                <div class="chart-card" id="student-absence-chart-container" style="display: none;">
                                     <div class="trend-chart-container">
                                        <canvas id="student-absence-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="attendance-list-view" class="student-view-content">
                        <div class="history-container">
                            <div class="filters-panel">
                                <h4>Filters</h4>
                                 <div class="form-group">
                                    <label for="student-history-start-date">Start Date</label>
                                    <input type="date" id="student-history-start-date">
                                </div>
                                <div class="form-group">
                                    <label for="student-history-end-date">End Date</label>
                                    <input type="date" id="student-history-end-date">
                                </div>
                                <button class="btn-small" id="fetch-student-history-btn" style="width: 100%;">Get History</button>
                            </div>
                            <div class="history-content">
                                <h4>My Attendance History</h4>
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Lecture Name</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="student-history-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // --- Get Firebase services from global window object ---
        const { collection, addDoc, onSnapshot, doc, setDoc, query, deleteDoc, updateDoc, where, Timestamp, getDocs, getDoc, writeBatch } = window.firebase;
        const { GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } = window.firebase;
        const db = window.db;
        const auth = window.auth;

        // --- AUTHORIZED ADMINS ---
        const ADMIN_EMAILS = ["mauryatushal07@gmail.com"];

        // --- DOM Elements ---
        const loader = document.getElementById('loader');
        const roleSelection = document.getElementById('role-selection');
        const appContainer = document.getElementById('app-container');
        const selectFacultyBtn = document.getElementById('select-faculty-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const selectStudentBtn = document.getElementById('select-student-btn');
        const backBtn = document.getElementById('back-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const loginStatus = document.getElementById('login-status');
        const mainContainer = document.querySelector('.main-container');
        const startSessionBtn = document.getElementById('start-session-btn');
        const closeSessionBtn = document.getElementById('close-session-btn');
        const identifyMeBtn = document.getElementById('identify-me-btn');
        const facultyStatus = document.getElementById('faculty-status');
        const studentStatus = document.getElementById('student-status');
        const presentList = document.getElementById('present-list');
        const historyPresentTableBody = document.getElementById('history-present-table-body');
        const presentListHeader = document.getElementById('present-list-header');
        const attendVideoContainer = document.getElementById('attend-video-container');
        const attendVideo = document.getElementById('attend-video');
        const enrollVideoContainer = document.getElementById('enroll-video-container');
        const enrollVideo = document.getElementById('enroll-video');
        const captureEnrollBtn = document.getElementById('capture-enroll-btn');
        const studentNameInput = document.getElementById('student-name-input');
        const studentIdInput = document.getElementById('student-id-input');
        const departmentSelect = document.getElementById('department-select');
        const studentSemesterSelect = document.getElementById('student-semester-select');
        const studentDivisionInput = document.getElementById('student-division-input');
        const sessionDepartmentSelect = document.getElementById('session-department-select');
        const sessionSemesterSelect = document.getElementById('session-semester-select');
        const sessionDivisionCheckboxes = document.getElementById('session-division-checkboxes');
        const addStudentBtn = document.getElementById('add-student-btn');
        const rosterTableBody = document.getElementById('roster-table-body');
        const facultyRosterTableBody = document.getElementById('faculty-roster-table-body');
        const rosterSearchInput = document.getElementById('roster-search-input');
        const facultyRosterSearchInput = document.getElementById('faculty-roster-search-input');
        const rosterTableHeaders = document.querySelectorAll('.data-table th[data-column]');
        const historyDatePicker = document.getElementById('history-date-picker');
        const pastSessionsTableBody = document.getElementById('past-sessions-table-body');
        const lectureNameInput = document.getElementById('lecture-name');
        const lectureDescriptionInput = document.getElementById('lecture-description');
        const showAddStudentFormBtn = document.getElementById('admin-show-add-student-form-btn');
        const addStudentForm = document.querySelector('.add-student-form');
        const facultyNavTabs = document.querySelectorAll('.faculty-nav > .nav-tab');
        const facultyViews = document.querySelectorAll('.faculty-view-content');
        const liveAttendancePlaceholder = document.getElementById('live-attendance-placeholder');

        // Faculty Login Elements
        const facultyLoginContainer = document.getElementById('faculty-login-container');
        const facultyUsernameInput = document.getElementById('faculty-username-input');
        const facultyPasswordInput = document.getElementById('faculty-password-input');
        const facultyLoginBtn = document.getElementById('faculty-login-btn');
        const facultyLoginBackBtn = document.getElementById('faculty-login-back-btn');
        const facultyLoginStatus = document.getElementById('faculty-login-status');
        
        // Admin - Manage Faculty Elements
        const adminNavTabs = document.querySelectorAll('.admin-portal .faculty-nav > .nav-tab');
        const adminViews = document.querySelectorAll('.admin-view-content');
        const newFacultyNameInput = document.getElementById('new-faculty-name');
        const newFacultyUsernameInput = document.getElementById('new-faculty-username');
        const newFacultyPasswordInput = document.getElementById('new-faculty-password');
        const addFacultyBtn = document.getElementById('add-faculty-btn');
        const addFacultyStatus = document.getElementById('add-faculty-status');
        const facultyTableBody = document.getElementById('faculty-table-body');
        
        // Admin - Manual Attendance Elements
        const manualSessionSelect = document.getElementById('manual-session-select');
        const manualAttendanceStudentList = document.getElementById('manual-attendance-student-list');
        const manualAttendanceTableBody = document.getElementById('manual-attendance-table-body');
        const saveManualAttendanceBtn = document.getElementById('save-manual-attendance-btn');
        const manualAttendanceStatus = document.getElementById('manual-attendance-status');

        // New elements for faculty viewing student history
        const facultyStudentHistoryView = document.getElementById('faculty-student-history-view');
        const facultyStudentHistoryHeader = document.getElementById('faculty-student-history-header');
        const facultyStudentHistoryTableBody = document.getElementById('faculty-student-history-table-body');
        const backToRosterBtn = document.getElementById('back-to-roster-btn');

        // Student Dashboard Elements
        const studentDashboard = document.getElementById('student-dashboard');
        const studentWelcomeHeader = document.getElementById('student-welcome-header');
        const studentNavTabs = document.querySelectorAll('#student-dashboard .nav-tab');
        const studentViews = document.querySelectorAll('.student-view-content');
        const studentAnalyticsStartDate = document.getElementById('student-analytics-start-date');
        const studentAnalyticsEndDate = document.getElementById('student-analytics-end-date');
        const fetchStudentAnalyticsBtn = document.getElementById('fetch-student-analytics-btn');
        const studentAbsenceChartCanvas = document.getElementById('student-absence-chart');
        const studentAbsenceChartContainer = document.getElementById('student-absence-chart-container');
        const studentAnalyticsLoader = document.getElementById('student-analytics-loader');
        const studentHistoryStartDate = document.getElementById('student-history-start-date');
        const studentHistoryEndDate = document.getElementById('student-history-end-date');
        const fetchStudentHistoryBtn = document.getElementById('fetch-student-history-btn');
        const studentHistoryTableBody = document.getElementById('student-history-table-body');
        const studentActiveSessionStatus = document.getElementById('student-active-session-status');
        
        // New Classroom Code elements
        const sessionCodeContainer = document.getElementById('session-code-container');
        const sessionCodeText = document.getElementById('session-code-text');
        const classroomCodeInput = document.getElementById('classroom-code-input');
        const submitCodeBtn = document.getElementById('submit-code-btn');

        
        // Analytics DOM Elements
        const analyticsDateRange = document.getElementById('analytics-date-range');
        const analyticsDepartment = document.getElementById('analytics-department');
        const analyticsSemester = document.getElementById('analytics-semester');
        const overallAttendanceChartCanvas = document.getElementById('overall-attendance-chart');
        const departmentAbsenceChartCanvas = document.getElementById('department-absence-chart');
        const dailyTrendsChartCanvas = document.getElementById('daily-trends-chart');
        const studentPerformanceTable = document.getElementById('student-performance-table');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');

        // --- State Variables ---
        let classRoster = [];
        let facultyList = [];
        let presentStudentIds = new Set();
        let faceMatcher = null;
        let videoFeedInterval = null;
        let attendanceListenerUnsubscribe = null;
        let identifiedStudent = null;
        let selectedHistorySessionId = null; 
        const CLASS_ID = "CS101";
        let overallAttendanceChart, departmentAbsenceChart, dailyTrendsChart, studentAbsenceChart;
        let isModelsLoaded = false;
        let activeSessionsForAdmin = [];
        
        // --- Authentication Logic ---
        const handleGoogleLogin = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                updateLoginStatus(`Login failed: ${error.message}`, 'error');
            }
        };

        const handleSignOut = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign out error:", error);
            }
        };

        const updateLoginStatus = (message, type = 'info') => {
            loginStatus.textContent = message;
            loginStatus.className = `status-box ${type}`;
            loginStatus.style.display = 'block';
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (ADMIN_EMAILS.includes(user.email)) {
                    showView('admin');
                } else {
                    signOut(auth);
                    updateLoginStatus('Access Denied: You are not an authorized admin.', 'error');
                    showRoleSelection();
                }
            } else {
                showRoleSelection();
            }
        });

        googleLoginBtn.addEventListener('click', handleGoogleLogin);
        signOutBtn.addEventListener('click', handleSignOut);


        // --- View Management ---
        const showView = (view) => {
            roleSelection.style.display = 'none';
            facultyLoginContainer.style.display = 'none';
            appContainer.style.display = 'block';
            mainContainer.className = 'main-container';
            mainContainer.classList.add(`${view}-view`);

            signOutBtn.style.display = (view === 'admin') ? 'block' : 'none';
            backBtn.style.display = (view === 'admin') ? 'none' : 'block';
        };
        const showRoleSelection = () => {
            roleSelection.style.display = 'flex';
            facultyLoginContainer.style.display = 'none';
            appContainer.style.display = 'none';
            identifiedStudent = null;
            studentDashboard.style.display = 'none';
            identifyMeBtn.style.display = 'block';
            studentStatus.style.display = 'block';
            updateStudentStatus('Click the button above to start verification.', 'info');
        };
        
        selectFacultyBtn.addEventListener('click', () => {
             roleSelection.style.display = 'none';
             facultyLoginContainer.style.display = 'flex';
        });
        selectStudentBtn.addEventListener('click', () => showView('student'));
        backBtn.addEventListener('click', showRoleSelection);

        function switchFacultyView(targetViewId) {
            facultyViews.forEach(v => v.classList.remove('active'));
            const targetView = document.getElementById(targetViewId);
            if(targetView) targetView.classList.add('active');

            facultyNavTabs.forEach(t => t.classList.remove('active'));
            const tabViewName = targetViewId === 'faculty-student-history-view' ? 'class-roster' : targetViewId.replace('-view', '');
            const correspondingTab = document.querySelector(`.nav-tab[data-view="${tabViewName}"]`);
            if (correspondingTab) {
                correspondingTab.classList.add('active');
            }
        }
        
        facultyNavTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const view = tab.getAttribute('data-view');
                switchFacultyView(`${view}-view`);
            });
        });
        
        studentNavTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                studentNavTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const view = tab.getAttribute('data-view');
                studentViews.forEach(v => v.classList.remove('active'));
                document.getElementById(`${view}-view`).classList.add('active');
            });
        });
        
        showAddStudentFormBtn.addEventListener('click', () => {
            addStudentForm.style.display = addStudentForm.style.display === 'flex' ? 'none' : 'flex';
        });
        
        // --- Helper Functions ---
        const generateSessionCode = () => {
            return Math.random().toString(36).substring(2, 7).toUpperCase();
        }

        // --- Core Logic ---
        async function loadModels() {
            if (isModelsLoaded) return;
            const loaderText = document.querySelector('#loader p');
            loaderText.textContent = 'Loading AI models...';
            try {
                const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                ]);
                isModelsLoaded = true;
                loader.style.display = 'none';
            } catch (error) {
                loaderText.textContent = 'Failed to load AI models. Please refresh.';
            }
        }
        
        const updateFacultyStatus = (message, type = 'info') => {
            facultyStatus.textContent = message;
            facultyStatus.className = `status-box ${type}`;
        };
        const updateStudentStatus = (message, type = 'info') => {
            studentStatus.textContent = message;
            studentStatus.className = `status-box ${type}`;
        };
        
        const deleteStudent = async (studentDocId) => {
            if (confirm("Are you sure you want to delete this student?")) {
                try {
                    await deleteDoc(doc(db, "classes", CLASS_ID, "roster", studentDocId));
                } catch (error) {
                    alert("Could not delete student.");
                }
            }
        };
        
        const listenToRoster = () => {
            let isFirstAnalyticsLoad = true;
            onSnapshot(collection(db, "classes", CLASS_ID, "roster"), (snapshot) => {
                const labeledFaceDescriptors = [];
                classRoster = [];
                snapshot.forEach(doc => {
                    const student = { id: doc.id, ...doc.data() };
                    classRoster.push(student);
                    if (student.faceDescriptor) {
                        labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(student.studentId, [Float32Array.from(Object.values(student.faceDescriptor))]));
                    }
                });

                renderRosterTable(classRoster, rosterTableBody, true); 
                renderRosterTable(classRoster, facultyRosterTableBody, false);
                updateDivisionCheckboxes();

                if (labeledFaceDescriptors.length > 0) {
                    faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.6);
                } else {
                    faceMatcher = null;
                }
                if (isFirstAnalyticsLoad && classRoster.length > 0) {
                    updateAnalyticsDashboard();
                    isFirstAnalyticsLoad = false;
                }
            });
        };
        
        const renderRosterTable = (rosterData, tableBody, isAdmin) => {
            tableBody.innerHTML = '';
            rosterData.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.studentId}</td>
                    <td>${student.department}</td>
                    <td>${student.semester}</td>
                    <td>${student.division}</td>
                    ${isAdmin ? '<td class="actions-cell"></td>' : ''}
                `;

                if (isAdmin) {
                    const actionsContainer = document.createElement('div');
                    actionsContainer.className = 'roster-actions';
                    
                    const menuBtn = document.createElement('button');
                    menuBtn.className = 'roster-menu-btn';
                    menuBtn.innerHTML = '&#8942;';
                    
                    const menu = document.createElement('ul');
                    menu.className = 'roster-menu';
                    menu.innerHTML = `
                        <li onclick="alert('Edit functionality coming soon!')">Edit Student</li>
                        <li class="delete">Delete Student</li>
                    `;
                    menu.querySelector('.delete').onclick = () => deleteStudent(student.id);
                    menuBtn.onclick = (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.roster-menu.active').forEach(m => m.classList.remove('active'));
                        menu.classList.toggle('active');
                    };
                    
                    actionsContainer.appendChild(menuBtn);
                    actionsContainer.appendChild(menu);
                    row.querySelector('.actions-cell').appendChild(actionsContainer);
                } else {
                    row.classList.add('clickable-row');
                    row.onclick = () => showStudentHistoryForFaculty(student);
                }

                tableBody.appendChild(row);
            });
        };

        const enrollStudent = async () => {
            const name = studentNameInput.value.trim();
            const studentId = studentIdInput.value.trim().toUpperCase();
            const department = departmentSelect.value;
            const semester = studentSemesterSelect.value;
            const division = studentDivisionInput.value.trim().toUpperCase();
            if (!name || !studentId || !division) {
                alert("Please fill out all student details.");
                return;
            }
            if (classRoster.some(s => s.studentId === studentId)) {
                alert("Student ID already exists. Please enter a different unique ID.");
                return;
            }

            updateFacultyStatus(`Please look at the camera, ${name}.`, 'info');
            enrollVideoContainer.style.display = 'block';
            captureEnrollBtn.style.display = 'block';
            addStudentBtn.disabled = true;

            try {
                enrollVideo.srcObject = await navigator.mediaDevices.getUserMedia({ video: {} });
            } catch (err) {
                updateFacultyStatus('Camera access denied.', 'error');
                addStudentBtn.disabled = false; return;
            }

            const cleanup = () => {
                clearInterval(videoFeedInterval);
                enrollVideo.srcObject?.getTracks().forEach(track => track.stop());
                enrollVideoContainer.style.display = 'none';
                captureEnrollBtn.style.display = 'none';
                const canvas = enrollVideoContainer.querySelector('canvas');
                if (canvas) canvas.remove();
                addStudentBtn.disabled = false;
            };
            
            captureEnrollBtn.onclick = async () => {
                const detection = await faceapi.detectSingleFace(enrollVideo).withFaceLandmarks().withFaceDescriptor();
                if (detection) {
                    try {
                        const descriptorAsObject = Object.assign({}, detection.descriptor);
                        await addDoc(collection(db, "classes", CLASS_ID, "roster"), {
                            name, studentId, department, semester, division,
                            faceDescriptor: descriptorAsObject 
                        });
                        studentNameInput.value = ''; studentIdInput.value = ''; studentDivisionInput.value = '';
                    } catch (e) {
                         alert("Could not add student to database.");
                    }
                    cleanup();
                } else {
                    alert("No face detected. Please position yourself and try again.");
                }
            };
            
            enrollVideo.onplaying = () => {
                const canvas = faceapi.createCanvasFromMedia(enrollVideo);
                enrollVideoContainer.append(canvas);
                const displaySize = { width: enrollVideoContainer.clientWidth, height: enrollVideoContainer.clientHeight };
                faceapi.matchDimensions(canvas, displaySize);
                const context = canvas.getContext('2d');
                videoFeedInterval = setInterval(async () => {
                    const detection = await faceapi.detectSingleFace(enrollVideo);
                    const resizedDetections = faceapi.resizeResults(detection, displaySize);
                    
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    if (resizedDetections) { faceapi.draw.drawDetections(canvas, resizedDetections); }

                }, 300);
            };
        };
        addStudentBtn.addEventListener('click', enrollStudent);

        const listenForActiveSession = () => {
            const q = query(collection(db, "sessions"), where("isActive", "==", true));
            onSnapshot(q, (snapshot) => {
                activeSessionsForAdmin = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data()}));
                if (snapshot.docs.length > 0) {
                    const activeSession = snapshot.docs[0].data();
                    startSessionBtn.disabled = true;
                    closeSessionBtn.disabled = false;
                    liveAttendancePlaceholder.style.display = 'none';
                    if (activeSession.sessionCode) {
                        sessionCodeText.textContent = activeSession.sessionCode;
                        sessionCodeContainer.style.display = 'block';
                    }
                    listenToAttendance(snapshot.docs[0].id, presentList);
                } else {
                    startSessionBtn.disabled = false;
                    closeSessionBtn.disabled = true;
                    presentList.innerHTML = '';
                    sessionCodeContainer.style.display = 'none';
                    liveAttendancePlaceholder.style.display = 'block';
                }
                populateManualSessionSelector();
            });
        };

        const handleManualAdd = async () => {
            const studentDocIdToAdd = document.getElementById('manual-add-select').value;
            if (!studentDocIdToAdd || !selectedHistorySessionId) {
                alert("Please select a student to add.");
                return;
            }

            const student = classRoster.find(s => s.id === studentDocIdToAdd);
            if (!student) {
                alert("Selected student not found in roster.");
                return;
            }

            try {
                await setDoc(doc(db, "sessions", selectedHistorySessionId, "presentStudents", student.id), {
                    name: student.name,
                    studentId: student.studentId,
                    timestamp: new Date()
                });
            } catch (error) {
                alert("Failed to add student manually. Please try again.");
            }
        };
        window.handleManualAdd = handleManualAdd; 

        const renderManualAddRow = (tableBody) => {
            const absentStudents = classRoster.filter(s => !presentStudentIds.has(s.studentId));
            
            const addRow = document.createElement('tr');
            
            if (absentStudents.length > 0) {
                let optionsHTML = '<option value="">-- Select a student to add --</option>';
                absentStudents.sort((a,b) => a.name.localeCompare(b.name)).forEach(student => {
                    optionsHTML += `<option value="${student.id}">${student.name} (${student.studentId})</option>`;
                });
                
                addRow.innerHTML = `
                    <td>
                        <select id="manual-add-select" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color);">${optionsHTML}</select>
                    </td>
                    <td>
                        <button class="btn-small" onclick="handleManualAdd()" style="background-color: var(--primary-color);">Add Student</button>
                    </td>
                `;
            } else {
                addRow.innerHTML = `<td colspan="2" style="text-align: center; font-style: italic; padding: 1rem;">All rostered students are present.</td>`;
            }
            
            tableBody.appendChild(addRow);
        };
        
        const listenToAttendance = (sessionId, element) => {
            if (attendanceListenerUnsubscribe) { attendanceListenerUnsubscribe(); }
            const presentRef = collection(db, "sessions", sessionId, "presentStudents");
            attendanceListenerUnsubscribe = onSnapshot(presentRef, (snapshot) => {
                element.innerHTML = '';
                presentStudentIds.clear();
                const presentStudentsList = [];
                snapshot.forEach(doc => {
                    const student = doc.data();
                    presentStudentIds.add(student.studentId);
                    presentStudentsList.push(student);
                });

                presentStudentsList.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

                presentStudentsList.forEach(student => {
                    const timestamp = student.timestamp?.toDate ? student.timestamp.toDate().toLocaleTimeString() : 'N/A';
                    if (element.tagName === 'UL') {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `${student.name} <span class="timestamp">${timestamp}</span>`;
                        element.appendChild(listItem);
                    } else {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${student.name}</td><td>${timestamp}</td>`;
                        element.appendChild(row);
                    }
                });
                
                if (element.id === 'history-present-table-body') {
                    renderManualAddRow(element);
                }
            });
        };
        
        startSessionBtn.addEventListener('click', async () => {
            if (classRoster.length === 0) { alert('Please add students to the roster first.'); return; }
            const lectureName = lectureNameInput.value.trim();
            if(!lectureName) { alert('Please enter a lecture or lab name.'); return; }
            
            updateFacultyStatus('Starting session...', 'info');
            startSessionBtn.disabled = true;
            
            const description = lectureDescriptionInput.value.trim();
            const department = sessionDepartmentSelect.value;
            const semester = sessionSemesterSelect.value;
            const selectedDivisions = Array.from(document.querySelectorAll('#session-division-checkboxes input:checked')).map(cb => cb.value);
            const sessionCode = generateSessionCode();

            try {
                await addDoc(collection(db, "sessions"), {
                    classId: CLASS_ID, lectureName, description, department, semester, 
                    divisions: selectedDivisions,
                    sessionCode: sessionCode,
                    isActive: true, createdAt: new Date()
                });
                updateFacultyStatus(`Session for "${lectureName}" is LIVE!`, 'success');
            } catch (e) {
                updateFacultyStatus('Could not start session in database.', 'error');
                startSessionBtn.disabled = false;
            }
        });

        
        closeSessionBtn.addEventListener('click', async () => {
            const q = query(collection(db, "sessions"), where("isActive", "==", true));
            const snapshot = await getDocs(q);
            if(snapshot.empty) {
                updateFacultyStatus("No active session to close.", "error"); return;
            }
            const sessionId = snapshot.docs[0].id;
            try {
                await updateDoc(doc(db, "sessions", sessionId), { isActive: false });
                updateFacultyStatus("Session closed successfully.", "success");
                if(attendanceListenerUnsubscribe) attendanceListenerUnsubscribe();
            } catch (error) {
                updateFacultyStatus("Could not close the session.", "error");
            }
        });
        
        submitCodeBtn.addEventListener('click', async () => {
            const code = classroomCodeInput.value.trim().toUpperCase();
            if (code.length !== 5) {
                studentActiveSessionStatus.textContent = 'Please enter a valid 5-character code.';
                studentActiveSessionStatus.className = 'status-box error';
                studentActiveSessionStatus.style.display = 'block';
                return;
            }
            if (!identifiedStudent) {
                 studentActiveSessionStatus.textContent = 'Error: Student not identified. Please go back and try again.';
                studentActiveSessionStatus.className = 'status-box error';
                studentActiveSessionStatus.style.display = 'block';
                return;
            }

            studentActiveSessionStatus.textContent = 'Verifying code...';
            studentActiveSessionStatus.className = 'status-box info';
            studentActiveSessionStatus.style.display = 'block';

            const q = query(collection(db, "sessions"), 
                where("isActive", "==", true), 
                where("sessionCode", "==", code),
                where("department", "==", identifiedStudent.department),
                where("semester", "==", identifiedStudent.semester)
            );
            const querySnapshot = await getDocs(q);

            let sessionToMark = null;
            querySnapshot.forEach(doc => {
                const session = {id: doc.id, ...doc.data()};
                if (session.divisions.length === 0 || session.divisions.includes(identifiedStudent.division)) {
                    sessionToMark = session;
                }
            });

            if (sessionToMark) {
                 try {
                    await setDoc(doc(db, "sessions", sessionToMark.id, "presentStudents", identifiedStudent.id), {
                        name: identifiedStudent.name, studentId: identifiedStudent.studentId, timestamp: new Date()
                    });
                    studentActiveSessionStatus.textContent = `Welcome, ${identifiedStudent.name}! Your attendance is marked.`;
                    studentActiveSessionStatus.className = 'status-box success';
                    classroomCodeInput.value = '';
                } catch(e) { 
                    studentActiveSessionStatus.textContent = 'Could not save attendance to database.';
                    studentActiveSessionStatus.className = 'status-box error';
                }
            } else {
                studentActiveSessionStatus.textContent = 'Invalid or expired code for your class. Please check the code and try again.';
                studentActiveSessionStatus.className = 'status-box error';
            }
        });
        
        const startFaceRecognitionForIdentification = async () => {
            updateStudentStatus('Starting camera to identify you...', 'info');
            attendVideoContainer.style.display = 'block';
            identifyMeBtn.disabled = true;
            try { attendVideo.srcObject = await navigator.mediaDevices.getUserMedia({ video: {} }); } catch (err) { updateStudentStatus('Camera access denied.', 'error'); return; }
            
            const cleanup = () => {
                clearInterval(videoFeedInterval);
                attendVideo.srcObject?.getTracks().forEach(track => track.stop());
                attendVideoContainer.style.display = 'none';
                const canvas = attendVideoContainer.querySelector('canvas');
                if (canvas) canvas.remove();
            };
            
            attendVideo.onplaying = () => {
                updateStudentStatus('Identifying student...', 'info');
                const canvas = faceapi.createCanvasFromMedia(attendVideo);
                attendVideoContainer.append(canvas);
                const displaySize = { width: attendVideoContainer.clientWidth, height: attendVideoContainer.clientHeight };
                faceapi.matchDimensions(canvas, displaySize);
                const context = canvas.getContext('2d');
                videoFeedInterval = setInterval(async () => {
                    const detection = await faceapi.detectSingleFace(attendVideo).withFaceLandmarks().withFaceDescriptor();
                    
                    const resizedDetections = faceapi.resizeResults(detection, displaySize);
                    
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    if (resizedDetections) { faceapi.draw.drawDetections(canvas, resizedDetections); }


                    if(detection && faceMatcher) {
                        const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                        if (bestMatch.label !== 'unknown') {
                            clearInterval(videoFeedInterval);
                            cleanup();
                            identifiedStudent = classRoster.find(s => s.studentId === bestMatch.label);
                            
                            identifyMeBtn.style.display = 'none';
                            studentStatus.style.display = 'none';
                            studentWelcomeHeader.textContent = `Welcome, ${identifiedStudent.name}!`;
                            studentDashboard.style.display = 'block';

                             const today = new Date();
                             const thirtyDaysAgo = new Date(new Date().setDate(today.getDate() - 30));
                             studentAnalyticsEndDate.value = today.toISOString().split('T')[0];
                             studentAnalyticsStartDate.value = thirtyDaysAgo.toISOString().split('T')[0];
                             studentHistoryEndDate.value = today.toISOString().split('T')[0];
                             studentHistoryStartDate.value = thirtyDaysAgo.toISOString().split('T')[0];
                        }
                    }
                }, 500);
            }
        };

        identifyMeBtn.addEventListener('click', () => {
            if (!faceMatcher) { updateStudentStatus('Roster data not loaded yet. Please wait.', 'error'); return; }
            startFaceRecognitionForIdentification();
        });
        
        const fetchSessionsForDate = async (date) => {
            pastSessionsTableBody.innerHTML = '<tr><td colspan="5">Loading sessions...</td></tr>';
            const startOfDay = new Date(date); startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(date); endOfDay.setHours(23, 59, 59, 999);
            const q = query(collection(db, "sessions"), 
                where("createdAt", ">=", Timestamp.fromDate(startOfDay)),
                where("createdAt", "<=", Timestamp.fromDate(endOfDay))
            );
            onSnapshot(q, (snapshot) => {
                pastSessionsTableBody.innerHTML = '';
                if (snapshot.empty) {
                    pastSessionsTableBody.innerHTML = '<tr><td colspan="5">No sessions found for this date.</td></tr>';
                    historyPresentTableBody.innerHTML = '';
                    return;
                }
                snapshot.forEach(doc => {
                    const session = { id: doc.id, ...doc.data() };
                    const row = document.createElement('tr');
                    row.className = 'clickable-row';
                    const sessionTime = session.createdAt.toDate().toLocaleTimeString();
                    const divisionText = session.divisions?.join(', ') || 'All';
                    row.innerHTML = `
                        <td>${session.lectureName || 'Session'}</td>
                        <td>${session.department}</td>
                        <td>${session.semester}</td>
                        <td>${divisionText}</td>
                        <td>${sessionTime}</td>
                    `;
                    row.onclick = () => {
                        document.querySelectorAll('#past-sessions-table-body tr').forEach(r => r.style.backgroundColor = '');
                        row.style.backgroundColor = '#EFF6FF';
                        selectedHistorySessionId = session.id;
                        presentListHeader.textContent = `Attendance for ${session.lectureName || 'Session'} at ${sessionTime}`;
                        listenToAttendance(session.id, historyPresentTableBody);
                    };
                    pastSessionsTableBody.appendChild(row);
                });
            });
        };
        
        const setupHistoryPicker = () => {
            const today = new Date().toISOString().split('T')[0];
            historyDatePicker.value = today;
            fetchSessionsForDate(historyDatePicker.valueAsDate);
            historyDatePicker.onchange = () => {
                if(historyDatePicker.valueAsDate) {
                   fetchSessionsForDate(historyDatePicker.valueAsDate);
                   historyPresentTableBody.innerHTML = '';
                   selectedHistorySessionId = null; 
                   presentListHeader.textContent = 'Selected Session Attendees';
                }
            };
        };
        
        const updateDivisionCheckboxes = () => {
            const selectedDept = sessionDepartmentSelect.value;
            const selectedSem = sessionSemesterSelect.value;
            
            const relevantStudents = classRoster.filter(s => s.department === selectedDept && s.semester === selectedSem);
            const uniqueDivisions = [...new Set(relevantStudents.map(s => s.division))];
            
            sessionDivisionCheckboxes.innerHTML = '';
            if (uniqueDivisions.length > 0) {
                uniqueDivisions.sort().forEach(div => {
                    const label = document.createElement('label');
                    label.innerHTML = `<input type="checkbox" value="${div}"> ${div}`;
                    sessionDivisionCheckboxes.appendChild(label);
                });
            } else {
                sessionDivisionCheckboxes.innerHTML = '<span>No divisions found for this selection.</span>';
            }
        };

        const showStudentHistoryForFaculty = (student) => {
            switchFacultyView('faculty-student-history-view');
            facultyStudentHistoryHeader.textContent = `Attendance History for ${student.name}`;
            fetchStudentHistoryForFaculty(student);
        };

        async function fetchStudentHistoryForFaculty(student) {
            facultyStudentHistoryTableBody.innerHTML = `<tr><td colspan="3">Fetching history...</td></tr>`;

            try {
                const sessionsQuery = query(collection(db, "sessions"));
                const sessionSnapshots = await getDocs(sessionsQuery);
                
                const relevantSessionsDocs = sessionSnapshots.docs.filter(doc => {
                    const session = doc.data();
                    return session.department === student.department &&
                           session.semester === student.semester &&
                           (!session.divisions || session.divisions.length === 0 || session.divisions.includes(student.division));
                });

                const attendancePromises = relevantSessionsDocs.map(sessionDoc => {
                    return getDoc(doc(db, "sessions", sessionDoc.id, "presentStudents", student.id))
                        .then(presentDoc => ({
                            sessionData: sessionDoc.data(),
                            wasPresent: presentDoc.exists()
                        }));
                });

                const results = (await Promise.all(attendancePromises)).filter(r => r !== null);
                results.sort((a, b) => b.sessionData.createdAt.toMillis() - a.sessionData.createdAt.toMillis());
                
                let historyHTML = '';
                results.forEach(result => {
                     historyHTML += `
                        <tr>
                            <td>${result.sessionData.createdAt.toDate().toLocaleDateString()}</td>
                            <td>${result.sessionData.lectureName}</td>
                            <td>${result.wasPresent ? '<span class="status-present">Present</span>' : '<span class="status-absent">Absent</span>'}</td>
                        </tr>
                     `;
                });

                facultyStudentHistoryTableBody.innerHTML = historyHTML || `<tr><td colspan="3">No sessions found for this student.</td></tr>`;
            } catch(error) {
                console.error("Error fetching student history for faculty:", error);
                facultyStudentHistoryTableBody.innerHTML = `<tr><td colspan="3" class="status-absent">Failed to load history. Please try again.</td></tr>`;
            }
        }
        backToRosterBtn.addEventListener('click', () => switchFacultyView('class-roster-view'));

        // --- Student Dashboard Functions ---
        async function updateStudentAnalyticsDashboard(student) {
            const startDate = studentAnalyticsStartDate.value;
            const endDate = studentAnalyticsEndDate.value;

            if (!startDate || !endDate) {
                studentAnalyticsLoader.textContent = 'Please select both a start and end date.';
                studentAnalyticsLoader.className = 'status-box error';
                studentAnalyticsLoader.style.display = 'block';
                studentAbsenceChartContainer.style.display = 'none';
                return;
            }

            studentAnalyticsLoader.textContent = 'Loading chart data...';
            studentAnalyticsLoader.className = 'status-box info';
            studentAnalyticsLoader.style.display = 'block';
            studentAbsenceChartContainer.style.display = 'none';
            if (studentAbsenceChart) studentAbsenceChart.destroy();

            try {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                const sessionsQuery = query(collection(db, "sessions"), 
                    where("createdAt", ">=", Timestamp.fromDate(start)),
                    where("createdAt", "<=", Timestamp.fromDate(end))
                );
                const sessionSnapshots = await getDocs(sessionsQuery);
                const absenceData = {};
                const relevantSessions = sessionSnapshots.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(session => 
                        session.department === student.department &&
                        session.semester === student.semester &&
                        (!session.divisions || session.divisions.length === 0 || session.divisions.includes(student.division))
                    );
                const attendanceChecks = relevantSessions.map(async (session) => {
                    const presentDoc = await getDoc(doc(db, "sessions", session.id, "presentStudents", student.id));
                    return {
                        date: session.createdAt.toDate().toLocaleDateString(),
                        isAbsent: !presentDoc.exists()
                    };
                });
                const results = await Promise.all(attendanceChecks);
                
                results.forEach(result => {
                    if (result && result.isAbsent) {
                        if (!absenceData[result.date]) absenceData[result.date] = 0;
                        absenceData[result.date]++;
                    }
                });
                const sortedDates = Object.keys(absenceData).sort((a,b) => new Date(a).getTime() - new Date(b).getTime());
                if (sortedDates.length === 0) {
                    studentAnalyticsLoader.textContent = 'No absence data found for this period.';
                    studentAnalyticsLoader.style.display = 'block';
                    studentAbsenceChartContainer.style.display = 'none';
                } else {
                    studentAnalyticsLoader.style.display = 'none';
                    studentAbsenceChartContainer.style.display = 'block';
                    studentAbsenceChart = new Chart(studentAbsenceChartCanvas, {
                        type: 'bar',
                        data: {
                            labels: sortedDates,
                            datasets: [{
                                label: 'Absences',
                                data: sortedDates.map(date => absenceData[date]),
                                backgroundColor: 'rgba(107, 114, 128, 0.7)',
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                            plugins: { legend: { display: true } }
                        }
                    });
                }
            } catch (error) {
                studentAnalyticsLoader.textContent = 'Failed to load chart data. Please try again.';
                studentAnalyticsLoader.className = 'status-box error';
            }
        }
        
        async function fetchStudentAttendanceHistory(student) {
            const startDate = studentHistoryStartDate.value;
            const endDate = studentHistoryEndDate.value;
            if (!startDate || !endDate) { alert("Please select both a start and end date."); return; }

            studentHistoryTableBody.innerHTML = `<tr><td colspan="3">Fetching history...</td></tr>`;
            try {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23,59,59,999);
                const sessionsQuery = query(collection(db, "sessions"), 
                    where("createdAt", ">=", Timestamp.fromDate(start)),
                    where("createdAt", "<=", Timestamp.fromDate(end))
                );
                const sessionSnapshots = await getDocs(sessionsQuery);
                const relevantSessionsDocs = sessionSnapshots.docs.filter(doc => {
                    const session = doc.data();
                    return session.department === student.department &&
                           session.semester === student.semester &&
                           (!session.divisions || session.divisions.length === 0 || session.divisions.includes(student.division));
                });
                const attendancePromises = relevantSessionsDocs.map(sessionDoc => {
                    return getDoc(doc(db, "sessions", sessionDoc.id, "presentStudents", student.id))
                        .then(presentDoc => ({
                            sessionData: sessionDoc.data(),
                            wasPresent: presentDoc.exists()
                        }));
                });
                const results = (await Promise.all(attendancePromises)).filter(r => r !== null);
                results.sort((a, b) => b.sessionData.createdAt.toMillis() - a.sessionData.createdAt.toMillis());
                
                let historyHTML = '';
                results.forEach(result => {
                     historyHTML += `
                        <tr>
                            <td>${result.sessionData.createdAt.toDate().toLocaleDateString()}</td>
                            <td>${result.sessionData.lectureName}</td>
                            <td>${result.wasPresent ? '<span class="status-present">Present</span>' : '<span class="status-absent">Absent</span>'}</td>
                        </tr>
                     `;
                });
                studentHistoryTableBody.innerHTML = historyHTML || `<tr><td colspan="3">No sessions found for your class in this date range.</td></tr>`;
            } catch(error) {
                studentHistoryTableBody.innerHTML = `<tr><td colspan="3" class="status-absent">Failed to load history. Please try again.</td></tr>`;
            }
        }
        
        fetchStudentAnalyticsBtn.addEventListener('click', () => { if(identifiedStudent) updateStudentAnalyticsDashboard(identifiedStudent); });
        fetchStudentHistoryBtn.addEventListener('click', () => { if (identifiedStudent) fetchStudentAttendanceHistory(identifiedStudent); });
        
        // --- Analytics Dashboard Logic ---
        async function updateAnalyticsDashboard() {
            if (classRoster.length === 0) return;
            const range = analyticsDateRange.value;
            const deptFilter = analyticsDepartment.value;
            const semFilter = analyticsSemester.value;

            const now = new Date();
            let startDate, endDate = new Date();
            endDate.setHours(23, 59, 59, 999);
            if (range === 'today') {
                startDate = new Date(now.setHours(0, 0, 0, 0));
            } else if (range === 'week') {
                startDate = new Date(new Date().setDate(now.getDate() - 7));
                startDate.setHours(0, 0, 0, 0);
            } else if (range === 'month') {
                startDate = new Date(new Date().setMonth(now.getMonth() - 1));
                startDate.setHours(0, 0, 0, 0);
            } else { // semester
                startDate = new Date(new Date().setMonth(now.getMonth() - 4));
                startDate.setHours(0, 0, 0, 0);
            }

            const sessionsQuery = query(collection(db, "sessions"), where("createdAt", ">=", Timestamp.fromDate(startDate)), where("createdAt", "<=", Timestamp.fromDate(endDate)));
            const sessionSnapshots = await getDocs(sessionsQuery);
            const sessions = sessionSnapshots.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let filteredRoster = classRoster;
            if (deptFilter !== 'all') filteredRoster = filteredRoster.filter(s => s.department === deptFilter);
            if (semFilter !== 'all') filteredRoster = filteredRoster.filter(s => s.semester === semFilter);
            
            let totalPresent = 0;
            const studentAttendance = {};
            const departmentData = {};
            const dailyData = {};

            filteredRoster.forEach(s => {
                studentAttendance[s.studentId] = {name: s.name, present: 0};
                if (!departmentData[s.department]) departmentData[s.department] = { present: 0, total: 0 };
                departmentData[s.department].total++;
            });
            for(const session of sessions) {
                const presentStudentsSnap = await getDocs(collection(db, "sessions", session.id, "presentStudents"));
                presentStudentsSnap.forEach(doc => {
                    const studentId = doc.data().studentId;
                    const studentDetails = filteredRoster.find(s => s.studentId === studentId);
                     if(studentAttendance[studentId] && studentDetails){
                        studentAttendance[studentId].present++;
                        totalPresent++;
                        departmentData[studentDetails.department].present++;
                     }
                });
                const dateString = session.createdAt.toDate().toISOString().split('T')[0];
                if(!dailyData[dateString]) dailyData[dateString] = {present: 0, total: 0};
                dailyData[dateString].present += presentStudentsSnap.size;
                dailyData[dateString].total += filteredRoster.length;
            }
            
            let totalPossibleAttendance = filteredRoster.length * sessions.length;
            let totalAbsent = totalPossibleAttendance - totalPresent;
            if (overallAttendanceChart) overallAttendanceChart.destroy();
            overallAttendanceChart = new Chart(overallAttendanceChartCanvas, {
                type: 'doughnut',
                data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{
                        data: [totalPresent, totalAbsent > 0 ? totalAbsent : 0],
                        backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(239, 68, 68, 0.7)'],
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
            });
            const deptLabels = Object.keys(departmentData);
            const deptAbsenceData = deptLabels.map(dept => {
                const data = departmentData[dept];
                const totalPossible = data.total * sessions.length;
                if(totalPossible === 0) return 0;
                const absence = totalPossible - data.present;
                return (absence / totalPossible) * 100;
            });
            if (departmentAbsenceChart) departmentAbsenceChart.destroy();
            departmentAbsenceChart = new Chart(departmentAbsenceChartCanvas, {
                type: 'bar',
                data: {
                    labels: deptLabels,
                    datasets: [{
                        label: 'Absence %',
                        data: deptAbsenceData,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, max: 100 } } }
            });
            const dailyLabels = Object.keys(dailyData).sort();
            const dailyPresentData = dailyLabels.map(date => dailyData[date].present);
            const dailyAbsentData = dailyLabels.map(date => dailyData[date].total - dailyData[date].present);
            if (dailyTrendsChart) dailyTrendsChart.destroy();
            dailyTrendsChart = new Chart(dailyTrendsChartCanvas, {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: [ { label: 'Present', data: dailyPresentData, borderColor: 'rgba(59, 130, 246, 0.7)', fill: false, }, { label: 'Absent', data: dailyAbsentData, borderColor: 'rgba(239, 68, 68, 0.7)', fill: false, } ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
            studentPerformanceTable.innerHTML = '';
            filteredRoster.forEach(student => {
                const percentage = sessions.length > 0 ? (studentAttendance[student.studentId].present / sessions.length * 100).toFixed(1) : 0;
                const row = document.createElement('tr');
                row.innerHTML = `<td>${student.name}</td><td>${percentage}%</td>`;
                studentPerformanceTable.appendChild(row);
            });
        }

        analyticsDateRange.addEventListener('change', updateAnalyticsDashboard);
        analyticsDepartment.addEventListener('change', updateAnalyticsDashboard);
        analyticsSemester.addEventListener('change', updateAnalyticsDashboard);
        exportPdfBtn.addEventListener('click', () => {
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             doc.text("Attendance Analytics Report", 20, 10);
             const tableData = [];
             studentPerformanceTable.querySelectorAll('tr').forEach(row => {
                const rowData = [];
                 row.querySelectorAll('td, th').forEach(cell => rowData.push(cell.innerText));
                 tableData.push(rowData);
             });
             doc.autoTable({ startY: 20, head: [['Student Name', 'Attendance %']], body: tableData.slice(1) });
             doc.save('attendance_report.pdf');
        });
        exportCsvBtn.addEventListener('click', () => {
            let csvContent = "data:text/csv;charset=utf-8,Student Name,Attendance %\n";
            studentPerformanceTable.querySelectorAll('tr').forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach(cell => rowData.push(`"${cell.innerText}"`));
                if(rowData.length > 0) csvContent += rowData.join(",") + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "attendance_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // --- Event Listeners ---
        sessionDepartmentSelect.addEventListener('change', updateDivisionCheckboxes);
        sessionSemesterSelect.addEventListener('change', updateDivisionCheckboxes);
        rosterSearchInput.addEventListener('keyup', () => {
            const searchTerm = rosterSearchInput.value.toLowerCase();
            const filteredRoster = classRoster.filter(student => student.name.toLowerCase().includes(searchTerm) || student.studentId.toLowerCase().includes(searchTerm) || student.department.toLowerCase().includes(searchTerm));
            renderRosterTable(filteredRoster, rosterTableBody, true);
        });
        facultyRosterSearchInput.addEventListener('keyup', () => {
            const searchTerm = facultyRosterSearchInput.value.toLowerCase();
            const filteredRoster = classRoster.filter(student => student.name.toLowerCase().includes(searchTerm) || student.studentId.toLowerCase().includes(searchTerm) || student.department.toLowerCase().includes(searchTerm));
            renderRosterTable(filteredRoster, facultyRosterTableBody, false);
        });
        rosterTableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const column = header.dataset.column;
                const order = header.dataset.order || 'desc';
                const newOrder = order === 'asc' ? 'desc' : 'asc';
                header.dataset.order = newOrder;
                rosterTableHeaders.forEach(h => h.removeAttribute('data-order-active'));
                header.setAttribute('data-order-active', newOrder);
                const sortedRoster = [...classRoster].sort((a, b) => {
                    const valA = (a[column] || '').toString().toLowerCase();
                    const valB = (b[column] || '').toString().toLowerCase();
                    if (valA < valB) return newOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return newOrder === 'asc' ? 1 : -1;
                    return 0;
                });
                renderRosterTable(sortedRoster, rosterTableBody, true);
                renderRosterTable(sortedRoster, facultyRosterTableBody, false);
            });
        });

        window.addEventListener('click', (e) => {
            if (!e.target.matches('.roster-menu-btn')) {
                document.querySelectorAll('.roster-menu.active').forEach(menu => menu.classList.remove('active'));
            }
        });

        // --- NEW Faculty Management and Login ---

        const updateFacultyLoginStatus = (message, type = 'info') => {
            facultyLoginStatus.textContent = message;
            facultyLoginStatus.className = `status-box ${type}`;
            facultyLoginStatus.style.display = 'block';
        };

        const handleFacultyLogin = async () => {
            const username = facultyUsernameInput.value.trim();
            const password = facultyPasswordInput.value;
            if (!username || !password) {
                updateFacultyLoginStatus('Please enter both username and password.', 'error');
                return;
            }
            updateFacultyLoginStatus('Verifying...', 'info');
            
            const q = query(collection(db, "faculty"), where("username", "==", username), where("password", "==", password));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                updateFacultyLoginStatus('Invalid username or password.', 'error');
            } else {
                facultyLoginStatus.style.display = 'none';
                facultyUsernameInput.value = '';
                facultyPasswordInput.value = '';
                showView('faculty');
            }
        };

        const listenToFaculty = () => {
            onSnapshot(collection(db, "faculty"), (snapshot) => {
                facultyList = [];
                snapshot.forEach(doc => {
                    facultyList.push({ id: doc.id, ...doc.data() });
                });
                renderFacultyTable(facultyList);
            });
        };

        const renderFacultyTable = (facultyData) => {
            facultyTableBody.innerHTML = '';
            facultyData.forEach(faculty => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${faculty.name}</td>
                    <td>${faculty.username}</td>
                    <td class="actions-cell">
                        <button class="btn-small btn-delete">Delete</button>
                    </td>
                `;
                row.querySelector('.btn-delete').onclick = () => deleteFaculty(faculty.id);
                facultyTableBody.appendChild(row);
            });
        };

        const addFaculty = async () => {
            const name = newFacultyNameInput.value.trim();
            const username = newFacultyUsernameInput.value.trim();
            const password = newFacultyPasswordInput.value;

            if (!name || !username || !password) {
                alert("Please fill out all faculty details.");
                return;
            }
             if (facultyList.some(f => f.username === username)) {
                alert("This username is already taken. Please choose a different one.");
                return;
            }
            try {
                await addDoc(collection(db, "faculty"), { name, username, password });
                newFacultyNameInput.value = '';
                newFacultyUsernameInput.value = '';
                newFacultyPasswordInput.value = '';
                addFacultyStatus.textContent = 'Faculty added successfully!';
                addFacultyStatus.className = 'status-box success';
                addFacultyStatus.style.display = 'block';
                setTimeout(() => addFacultyStatus.style.display = 'none', 3000);
            } catch (e) {
                addFacultyStatus.textContent = 'Error adding faculty.';
                addFacultyStatus.className = 'status-box error';
                addFacultyStatus.style.display = 'block';
            }
        };

        const deleteFaculty = async (facultyId) => {
            if (confirm("Are you sure you want to delete this faculty member?")) {
                try {
                    await deleteDoc(doc(db, "faculty", facultyId));
                } catch (error) {
                    alert("Could not delete faculty member.");
                }
            }
        };

        adminNavTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                adminNavTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const view = tab.getAttribute('data-view');
                adminViews.forEach(v => v.classList.remove('active'));
                document.getElementById(`${view}-view`).classList.add('active');
                if(view === 'manual-attendance'){
                    populateManualSessionSelector();
                }
            });
        });

        facultyLoginBtn.addEventListener('click', handleFacultyLogin);
        facultyLoginBackBtn.addEventListener('click', showRoleSelection);
        addFacultyBtn.addEventListener('click', addFaculty);
        
        // --- Admin Manual Attendance Logic ---
        const populateManualSessionSelector = () => {
            manualSessionSelect.innerHTML = '';
            if (activeSessionsForAdmin.length === 0) {
                manualSessionSelect.innerHTML = '<option value="">No active sessions</option>';
                manualAttendanceStudentList.style.display = 'none';
                return;
            }

            manualSessionSelect.innerHTML = '<option value="">-- Select a session --</option>';
            activeSessionsForAdmin.forEach(session => {
                const option = document.createElement('option');
                option.value = session.id;
                option.textContent = `${session.lectureName} (${session.department} - Sem ${session.semester})`;
                option.dataset.sessionData = JSON.stringify(session);
                manualSessionSelect.appendChild(option);
            });
        };

        manualSessionSelect.addEventListener('change', async (e) => {
            const selectedOption = e.target.selectedOptions[0];
            if (!selectedOption.value) {
                manualAttendanceStudentList.style.display = 'none';
                return;
            }
            const session = JSON.parse(selectedOption.dataset.sessionData);
            
            // Get students already present
            const presentStudentsSnap = await getDocs(collection(db, "sessions", session.id, "presentStudents"));
            const presentStudentIds = presentStudentsSnap.docs.map(doc => doc.data().studentId);
            
            // Filter roster for this session
            const eligibleStudents = classRoster.filter(student => 
                student.department === session.department &&
                student.semester === session.semester &&
                (session.divisions.length === 0 || session.divisions.includes(student.division))
            );

            manualAttendanceTableBody.innerHTML = '';
            eligibleStudents.forEach(student => {
                const isPresent = presentStudentIds.includes(student.studentId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" value="${student.id}" data-student='${JSON.stringify(student)}' ${isPresent ? 'checked' : ''}></td>
                    <td>${student.name}</td>
                    <td>${student.studentId}</td>
                `;
                manualAttendanceTableBody.appendChild(row);
            });
            manualAttendanceStudentList.style.display = 'block';
        });

        saveManualAttendanceBtn.addEventListener('click', async () => {
            const sessionId = manualSessionSelect.value;
            if (!sessionId) {
                alert("Please select a session first.");
                return;
            }
            
            const checkboxes = manualAttendanceTableBody.querySelectorAll('input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert("No students selected.");
                return;
            }

            try {
                const batch = writeBatch(db);
                checkboxes.forEach(cb => {
                    const student = JSON.parse(cb.dataset.student);
                    const presentDocRef = doc(db, "sessions", sessionId, "presentStudents", student.id);
                    batch.set(presentDocRef, {
                        name: student.name,
                        studentId: student.studentId,
                        timestamp: new Date()
                    });
                });
                await batch.commit();
                
                manualAttendanceStatus.textContent = 'Attendance saved successfully!';
                manualAttendanceStatus.className = 'status-box success';
                manualAttendanceStatus.style.display = 'block';
                setTimeout(() => manualAttendanceStatus.style.display = 'none', 3000);

            } catch(error) {
                manualAttendanceStatus.textContent = 'Error saving attendance.';
                manualAttendanceStatus.className = 'status-box error';
                manualAttendanceStatus.style.display = 'block';
            }
        });
        
        // --- Initialization ---
        async function initializeApp() {
            await loadModels();
            listenToRoster();
            listenToFaculty();
            listenForActiveSession();
            setupHistoryPicker();
        }

        initializeApp();

    </script>
</body>
</html>

